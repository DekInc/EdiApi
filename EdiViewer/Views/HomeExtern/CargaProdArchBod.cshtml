@using ComModels
@{
    ViewData["Title"] = "Carga de archivo de escaners de bodega";
    Layout = "_Layout";
}
<div id="mainDiv">
    <div class="container">
        <div class="card-deck cardMain">
            <div class="card box-shadow">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">Carga de archivo de escaners de bodega Payless&nbsp;<img class="imgHeaderHelp" src="~/images/help.png" title="Pantalla utilizada para cargar los archivos que bodega escaneo, si se carga un archivo diferente para el mismo periodo los datos serán substituidos. Al subir el archivo se creara uno nuevo para que se pueda introducir la información al WMS." alt="Pantalla utilizada para cargar los archivos que bodega escaneo, si se carga un archivo diferente para el mismo periodo los datos serán substituidos. Al subir el archivo se creara uno nuevo para que se pueda introducir la información al WMS."></h4>
                </div>
                <div class="card-body">
                    <form id="formSearch">
                        <div class="container div856Search">
                            <div class="row">                                
                                <div class="col-sm">
                                    <label for="cboPeriod">Periodo</label>
                                    <select class="form-control" id="cboPeriod"></select>
                                </div>
                                <div class="col-sm">
                                    <label for="cboTransporte">Transporte</label>
                                    <div id="divSpinCboTransporte" class="spinner-border spinner-border-sm text-danger" style="display: none" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <select class="form-control" id="cboTransporte" name="cboTransporte"></select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm custom-file divUpload">
                                    <input type="file" class="custom-file-input inputUpload" id="fUpload" name="fUpload">
                                    <label id="lblFile" class="custom-file-label" for="fUpload">Archivo a cargar</label>
                                </div>
                            </div>
                            <div class="row margin5">
                                <div class="col-sm">
                                    <button class="btn btn-primary" type="button" id="btnUpload">
                                        &nbsp;&nbsp;&nbsp;Cargar archivo&nbsp;&nbsp;&nbsp;
                                        <div id="divSpinUploadFile" class="spinner-border spinner-border-sm text-danger" style="display: none" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <form id="formReportes" action=""></form>
                    <div class="clearfix"></div>
                    <br />
                    <div id="gridScans" style="min-height: 460px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync("_PopCargaProdArchBodDet")
<script>
    var tblReportes = null;
    var mainGrid = null;
    function getPeriods() {
        $.ajax({
            url: '@this.Url.Action("GetPaylessPeriodPriori")',
            type: 'GET',
            dataType: 'JSON',
            success: function (json) {
                if (json.info.codError != 0) {
                    menErrorEdi(json.info.mensaje);
                    return json.data;
                }
                $('#cboPeriod').empty();
                $.each(json.data, function (indexI, itemO) {
                    $('#cboPeriod').append($('<option>', {
                        value: this,
                        text: this,
                        selected: false
                    }));
                });
                getTransportes()
            },
            error: function (xhr, ajaxOptions, thrownError) {
                menErrorEdi(xhr.status, '');
                menErrorEdi(thrownError, '');
            }
        });
    }
    function getTransportes() {
        if ($('#dtpPeriodoBuscar').val() == '') return;
        $('#divSpinCboTransporte').show();
        $.ajax({
            url: '@this.Url.Action("GetTransportByPeriod", "HomeExtern")?Period=' + $('#cboPeriod').val(),
            type: 'GET',
            dataType: 'JSON',
            success: function (json) {
                $('#divSpinCboTransporte').hide();
                if (json.info.codError != 0) {
                    menErrorEdi(json.info.mensaje);
                    return json.data;
                }
                $('#cboTransporte').empty();
                $.each(json.data, function (indexI, itemO) {
                    $('#cboTransporte').append($('<option>', {
                        value: this.idTransporte,
                        text: this.transporte,
                        selected: false
                    }));
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
                menErrorEdi(xhr.status, '');
                menErrorEdi(thrownError, '');
            }
        });
    }
    function refreshGrid(auto) {
        w2ui.grid.autoLoad = auto;
        w2ui.grid.skip(0);
    }
    function crearGrid() {
        var config = {
            grid: {
                name: 'gridScans',
                selectType: 'cell',
                bResponsive: true,
                bMobile: window.mobileAndTabletcheck(),
                url: '@this.Url.Action("GetPaylessPeriodPrioriFile", "Grids")',
                show: {
                    footer: true,
                    toolbar: true,
                    expandColumn: window.mobileAndTabletcheck()                    
                },
                searches: [
                    { field: "clientName", caption: "Cliente", type: 'text' },
                    { field: "periodo", caption: "Periodo", type: 'text' }
                ],
                colShowResponsive: [
                    { field: 'clientName' },
                    { field: 'periodo' }
                ],
                columns: [                    
                    { field: "id", caption: "Id", sortable: true, hidden: true },
                    { field: "periodo", caption: "Periodo", sortable: true },
                    { field: "transporte", caption: "Transporte", sortable: true },                    
                    {
                        field: "insertDate", caption: "Fecha de carga / actualización", sortable: true, render: function (record) {
                            if (record.updateDate)
                                return '<div>' + record.updateDate + '</div>';
                            else
                                return '<div>' + record.insertDate + '</div>';
                        }
                    },
                    { field: "porValid", caption: "Porc. validez", sortable: true },                    
                    {
                        field: "updateDate", caption: "", sortable: true, render: function (record) {
                            return '<a href="javascript:downloadWmsFile(' + "'" + record.id + "'" + ')">Archivo WMS</a>&nbsp;|&nbsp;<a href="javascript:verDetalle(' + record.id + ')">Ver detalle</a>';
                        }
                    }
                ]
            }
        };
        mainGrid = $('#gridScans').w2grid(config.grid);
        arrayGrids['gridScans'] = mainGrid;
    }    
    function downloadWmsFile(idM) {
        window.open('@this.Url.Action("MakeExcelWms1", "HomeExtern")?IdM=' + idM);
        @*return;
        $.ajax({
            type: "GET",
            url: '@this.Url.Action("MakeExcelWms1", "HomeExtern")',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            //data: fdata,
            contentType: false,
            processData: false,
            success: function (response) {
                document.write(response);
            },
            error: function (resp) {
                menErrorEdi('Error ' + resp, 'Error');
                //menErrorEdi(resp.info.mensaje);
            }
        });*@
    }
    function verDetalle(idM) {
        idProdArch = idM;
        gridRepDet1.reload2('@this.Url.Action("GetPaylessFileDif", "Grids")?idProdArch=' + idProdArch + '&idData=1');
        $('#modalCargaProdArchBodDet').modal();        
    }
    $(document).ready(function () {
        $('.imgHeaderHelp').tooltip();
        getPeriods();        
        crearGrid();
        $('#cboPeriod').on('change', function (Event) {
            getTransportes();
        });
        $('#fUpload').on('change', function (event) {
            var fullPath = $('#fUpload').val();
            if (fullPath) {
                var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                var filename = fullPath.substring(startIndex);
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                }
                $('#lblFile').text(filename);
            }
        });
        $('#btnUpload').on('click', function () {
            if ($('#cboPeriod').val() == '') {
                menErrorEdi('El valor del periodo no puede estar vacio', 'Error');
                return;
            }
            var fileExtension = ['xml', 'XML'];
            var filename = $('#fUpload').val();
            if (filename.length == 0) {
                menErrorEdi('Por favor seleccione un archivo', 'Error');
                return false;
            }
            else {
                var extension = filename.replace(/^.*\./, '');
                if ($.inArray(extension, fileExtension) == -1) {
                    menErrorEdi('Solo se permiten archivos de handheld con extensiones: .xml', 'Error');
                    return false;
                }
            }
            $('#divSpinUploadFile').show();
            var fdata = new FormData();
            var fileUpload = $("#fUpload").get(0);
            var files = fileUpload.files;
            fdata.append(files[0].name, files[0]);
            $.ajax({
                type: "POST",
                url: '@this.Url.Action("SetPaylessPeriodPrioriFile", "HomeExtern")?CboPeriod=' + $('#cboPeriod').val() + '&IdTransporte=' + $('#cboTransporte').val(),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                data: fdata,
                contentType: false,
                processData: false,
                success: function (response) {
                    $('#divSpinUploadFile').hide();
                    if (response.info.codError != null) {
                        if (response.info.codError != 0) {
                            menErrorEdi(response.info.mensaje, 'Error en el proceso');
                            return;
                        }
                    }
                    if (response.length == 0)
                        menErrorEdi('Error al subir el archivo', 'Error');
                    else {
                        if (response.info.codError == 0)
                            menErrorEdi('Archivo cargado', 'Información');
                        mainGrid.reload();
                    }
                },
                error: function (resp) {
                    $('#divSpinUploadFile').hide();
                    menErrorEdi(resp.info.mensaje);
                }
            });
        });
        if (window.mobileAndTabletcheck()) {
            $('.div856Search').css({ "max-width": "unset" });
            $('#dtpPeriodoBuscar').css({ "width": "100%" });
            $('.btn').css({ "margin-bottom": "10px" });
            $('.btn').addClass('btn-block');
            $("#tblReportes").hide();
            $('.inputUpload').css({ "max-width": "84vw" });
            $('.divUpload').css({ "max-width": "84vw" });
        }
    });
</script>
